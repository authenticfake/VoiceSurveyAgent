# REQ-003 Dependencies
pytest>=8.0
pytest-asyncio>=0.23
pytest-cov>=4.1
httpx>=0.27
pyjwt[crypto]>=2.8
structlog>=24.1
sqlalchemy[asyncio]>=2.0
asyncpg>=0.29
fastapi>=0.111
pydantic>=2.7
pydantic-settings>=2.2
```

---

## KIT Iteration Log

### Targeted REQ-ID(s)
- **REQ-003**: RBAC authorization middleware

### Rationale
REQ-003 depends on REQ-002 (OIDC authentication) which is marked as in_progress. This implementation extends the authentication module to add role-based access control.

### In Scope
- Role extraction from JWT claims (direct, Keycloak realm_access, resource_access)
- Role hierarchy (admin > campaign_manager > viewer)
- FastAPI dependencies for route protection
- Access denial logging with user ID, endpoint, and timestamp
- Custom exceptions for authentication and authorization errors

### Out of Scope
- OIDC flow implementation (covered by REQ-002)
- Database migrations (covered by REQ-001)
- Campaign-specific authorization rules (will be in REQ-004+)

### How to Run Tests

```bash
# Set environment
export PYTHONPATH="runs/kit/REQ-003/src:runs/kit/REQ-004/src"
export DATABASE_URL="postgresql://postgres:postgres@localhost:5432/voicesurvey_test"
export OIDC_ISSUER_URL="https://idp.example.com"
export OIDC_CLIENT_ID="test-client-id"

# Install dependencies
pip install pytest pytest-asyncio pytest-cov httpx pyjwt[crypto] structlog sqlalchemy[asyncio] asyncpg fastapi pydantic pydantic-settings

# Run tests
pytest runs/kit/REQ-003/test/ -v
```

### Prerequisites
- Python 3.12+
- PostgreSQL 15+ (for integration tests, mocked in unit tests)
- Dependencies from requirements.txt

### Dependencies and Mocks
- **AuthService**: Mocked JWKS client for token validation tests
- **Database**: Mocked AsyncSession for user lookup tests
- **User model**: Imported from REQ-004's campaigns module

### Product Owner Notes
- Role hierarchy follows standard RBAC pattern with 3 levels
- Logging includes all required fields for audit compliance
- Type aliases (ViewerUser, CampaignManagerUser, AdminUser) simplify route definitions

### RAG Citations
- `runs/kit/REQ-004/src/app/auth/rbac.py` - Extended existing RBAC structure
- `runs/kit/REQ-004/src/app/auth/schemas.py` - Reused TokenPayload and UserContext schemas
- `runs/kit/REQ-004/src/app/campaigns/models.py` - User model reference
- `runs/kit/REQ-001/src/storage/sql/V0001.up.sql` - Database schema for user_role enum

```json
{
  "index": [
    {
      "req": "REQ-003",
      "src": [
        "runs/kit/REQ-003/src/app/auth/rbac.py",
        "runs/kit/REQ-003/src/app/auth/service.py",
        "runs/kit/REQ-003/src/app/shared/exceptions.py",
        "runs/kit/REQ-003/src/app/auth/__init__.py"
      ],
      "tests": [
        "runs/kit/REQ-003/test/test_rbac.py",
        "runs/kit/REQ-003/test/test_auth_service.py"
      ]
    }
  ]
}
```
Human: /kit REQ-003